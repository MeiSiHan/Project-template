<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv=Content-Type content="text/html;charset=utf-8">
  <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1">
  <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
  <script type="text/javascript" src="js/qwebchannel.js"></script>
  <title>freq chart</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      touch-action: none;
      /* 禁止触摸屏上的缩放 */
    }
    #lock_mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      text-align: center;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10;
      display: none;
      justify-content: center;
      align-items: center;

    }
    #onload_mask{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      text-align: center;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 11;
      display: none;
      justify-content: center;
      align-items: center;
      color: #0097ef;
      font-size: 50px;
    }
    #mycanvas {
      margin: 0;
      width: 100%;
      height: 80%;
      position: relative;
      box-sizing: border-box;
      border: 2px solid transparent;
    }

    #bottomBox {
      display: none;
      position: absolute;
      left: 0px;
      /* bottom: 50px; */
      height: 100%;
      width: 40px;
      z-index: 2;
      background-color: #70797e;
      flex-direction: column;
      box-sizing: border-box;
    }

    #bottomBox .button {
      width: 100%;
      /* height: 40px; */
      border: 2px solid transparent;
      /* margin: 4px; */
      cursor: pointer;
      /* border-radius: 6px; */
      background-color: rgba(50, 63, 72, 0.6);
      /* background-color: #323f48; */
      /* background-size: 100% 100%; */
      background-size: contain;
      /* 保持图片比例，不放大 */
      background-repeat: no-repeat;
      /* 防止图片重复显示 */
      background-position: center center;
      box-sizing: border-box;
      /* 水平垂直居中 */
    }

    /* #bottomBox .button:first-child {
      margin-bottom: 2px;
    } */
    #bottomBox .button:last-child {
      margin-top: 4px;
    }
    #bottomBox .button:hover {
      background-color: #3b8df3 !important;
    }

    .active {
      border: 2px solid red !important;
    }

    #zoom_in {
      display: none;
      background-image: url("img/up.png");
    }

    #zoom_out {
      background-image: url("img/down.png");
    }

    #switch_button {
      display: none;
      background-image: url("img/switch.png");
    }

    #consolelogs-box {
      position:fixed;
      right: 6px;
      top: 2px;
      width: 60%;
      min-height: 60px;
      min-width: 300px;
      height: 60%;
      background-color: #ccc;
      overflow: auto;
      padding-top: 30px;
      box-sizing: border-box;
    }
    #console-box{
      height: 30px;
      position: absolute;
      top:0;
    }
    #consolelogs{
      line-height: 30px;
      height: 99%;
      overflow: auto;
    }
    #consolelogs p{
      margin:0;
    }

    #scroll-bar {
      position: absolute;
      width: 18px;
      height: 500px;
      top: 0;
      right: 0;
      background-color: #f5f5f5;
      z-index: 1;
      overflow-y: auto;
      border-radius: 4px;
      display: none;;
    }
    #scroll-bar-content{
      width: 100%;
      height: 100%;
    }

/* 整体滚动条容器 */
::-webkit-scrollbar {
  width: 12px;        /* 垂直滚动条宽度 */
  height: 12px;       /* 水平滚动条高度 */
  background: #f5f5f5; /* 轨道背景色 */
}

/* 滚动条轨道 */
::-webkit-scrollbar-track {
  border-radius: 6px;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1); /* 内阴影效果 */
}

/* 滚动条滑块 */
::-webkit-scrollbar-thumb {
  background: linear-gradient(45deg, #888, #666); /* 渐变效果 */
  border: 2px solid #f5f5f5; /* 轨道留白 */
  border-radius: 6px;
  transition: background 0.3s; /* 动画过渡 */
}

/* 滑块悬停态 */
::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(45deg, #666, #444);
}

/* 滚动条边角（右下角交汇处）*/
::-webkit-scrollbar-corner {
  background: #f0f0f0;
}

/* 按钮（上下箭头）*/
::-webkit-scrollbar-button {
  height: 0;          /* 隐藏默认箭头按钮 */
  display: none;
}


  </style>
</head>

<body>
  <div id="lock_mask"></div>
  <div id="onload_mask"></div>
  <div id="mycanvas">
    <div id="bottomBox">
      <div id="zoom_in" class="button" dataid="0"></div>
      <!-- <div id="zoom_out" class="button" dataid="1"></div> -->
      <div id="switch_button" class="button"></div>
    </div>
  </div>
  <div id="scroll-bar">
    <div id="scroll-bar-content"></div>
  </div>
  <div id="bottom-box" style="display: none;">
    <p><input type="file" id="jsonFile"><span id="fileinfo"></span></p>
    <p style="margin:0 10px;">频率范围：<input type="number" id="minfreq" style="width: 100px;">
        --<input type="number" id="maxfreq" style="width: 100px;">
        <button onclick="setfreqClick()">设置频率</button>
    </p>
    <button onclick="setInitFreqClick()">设置初始频率</button>
    <button onclick="onloadpageclick(1)">加载数据1</button>
    <button onclick="updateClick()">更新数据</button>
    <button id="onloadclick" onclick="window.location.reload()">刷新页面</button>
    <button id="onloadclick" onclick="cleartext()">清空</button>
    
    <button onclick="updateOptionClick()">更新配置</button>
    
    <button onclick="setlock(true)">锁屏</button>
    <button onclick="setlock(false)">关锁屏</button>
    <button onclick="setKey(0)">上</button>
    <button onclick="setKey(1)">下</button>
    <button onclick="setKey(2)">左</button>
    <button onclick="setKey(3)">右</button>
    <button onclick="setKey(4)">确定</button>
    <button onclick="setKey(5)">返回</button>
    <button onclick="setKey(6)">清除</button>
    <button onclick="openPopup()">打开弹窗</button>
    <button onclick="getFreqBussiness()">获取业务名称</button>
  </div>
  <div id="consolelogs-box">
    <div id="console-box">
      <button onclick="colsePopup()">关闭弹窗</button>
      <button onclick="openConsole()">切换打印</button>
      <button onclick="cleartext()">清空</button>
      <button onclick="showbutton()">显示按钮</button>
      <button onclick="getmus()">获取内存</button>
      <button onclick="getOptions()">获取属性</button>
    </div>
    <div id="consolelogs"></div>
  </div>
  <!-- 引入你的编译库 -->

  <script src="./dist/freqChart.js"></script>
  <script src="../dist/freqChart.js"></script>


  <!-- <script src="./src/indextest.js"></script> -->
  <script>
    var isSendOk=false;
    var isopenConsole=true;
    var freqCharts = ""
    var filedata = ""
    // window.onload = function() {


    //功能方法
    function startmethod(data) {
      var types = data.operate_type;
      if (types == "load_chart") {
        onloadPage(data)
      } else {
        if (freqCharts == null || freqCharts == "") {
          console.log("未初始化")
          return false;
        }
        if (types == "update_chart") {
          //更新数据
          freqCharts.setChartData(data.operate_data.data_chart)
        } else if (types == "update_options") {
          //更新配置
          freqCharts.updateOptions(data.operate_data.data_options)
        } else if (types == "set_freq_range") {
          if(data.operate_data.data_freqs&&data.operate_data.data_freqs.type=="init"){
            freqCharts.setInitFreqRange(data.operate_data.data_freqs)
            //设置频率范围
          }else{
            //设置频率范围
            freqCharts.setfreqRange(data.operate_data.data_freqs)
          }
          
        } else if (types == "set_lock") {
          freqCharts.setLock(data.operate_data.lock_status)
        } else if (types == "set_key") {
          freqCharts.setKey(data.operate_data.data_key)
        }else if(types == "set_scale_button"){
          freqCharts.setZoom(data.operate_data.scale_status)
        } else if(types == "get_freq_bussiness"){
          var results=freqCharts.getFreqBussiness(data.operate_data.data_freqs)
          var messageObj = {
            "callback_type":"freq_bussiness_name",
            "callback_data":{
              "names":results
            }
          }
          var message = JSON.stringify(messageObj);
          sendMessage(message)
          console.log("获取业务名称",message)
        }
      }
    }

    function onloadpageclick(nums,filedatas) {
      var data = {
        "operate_type": "load_chart",
        "operate_data": {
          "data_options": {
            "language_code": 2052, //语言代码 2052中文 1033英文
            "type": nums, //1普通 2wifi 3 3GPP 4运营商
            "background": [255, 255, 255, 1], //背景色
            "height":600,
            "isPrint":true,
            "isreadfile":true,
            "grid": { //网格样式
              "left": 50, //左边距
              "right": 5, //右边距
              "bottom": 40, //下边距
              "track_gap":30, //行间距
              "stroke_color": [51, 51, 51, 1], //网格线颜色
              "stroke_width": 1, //网格线宽度
              "stroke_focus_width": 2, //网格线焦点宽度
              "stroke_focus_color": [250, 0, 0, 1], //网格线焦点颜色
            },
            "x_axis": { //X轴样式
              "decimals": "", //X轴刻度标签小数位数
              "unit": "MHz", //单位MHz 为空不显示
              "unit_position": "bottom", //单位位置 top顶部 bottom底部
              "show_top_label": true, //是否显示顶部标签
              "show_bottom_label": true, //是否显示底部标签
              "init_start_freq": 200000000, //X轴起始频率
              "init_end_freq": 500000000, //X轴结束频率
            },
            "button": {
              "show_zoom_button": true, //是否显示缩放按钮
              "background_button": [50, 63, 72, 1], //按钮背景色
              "show_switch_button": true, //是否显示切换按钮
            },
            "lock": {//锁屏样式
              "content": "测试",
              "font_size": 40, //图标字体大小
              "color": [255, 255, 255, 1], //字体颜色
              "background": [0, 60, 136, 0.5] //背景颜色
            }
          },
          "data_chart":filedatas||filedata
          // "data_chart": window["tree_data"+nums] || tree_data1, //图表数据
        }

      }
      console.log("加载数据",data)
       startmethod(data)
    }
    //加载图表
    function onloadPage(data) {
      var options = data.operate_data.data_options
      var tree_datas = data.operate_data.data_chart
      console.log("加载图标options",options)
      freqCharts = new freqChart("mycanvas", options, tree_datas);
      freqCharts.onClick(function (data) {
        console.log("控件点击事件", data)
        gridClickMessage(data)
      })
      freqCharts.onFreq(function (min, max) {
        console.log("控件频率改变事件", min, max)
        //setfreqClick(min, max)
        //freqMessage(min, max)
        var message = '{"callback_type":"freq_change","callback_data":{"start_freq":' + min + ',"end_freq":' + max + '}}'
        sendMessage(message)
      })
      freqCharts.onKey(function (data) {
        console.log("控件频率按键消息", data)
      })
      freqCharts.onClickZoom(function (data) {
        console.log("控件点击缩放消息", data)
        //buttonClickMessage(data)
        var message ='{"callback_type":"click_scale_button","callback_data":{"data_type":"button","scale_value": ' + data + '}}'
        sendMessage(message)
        // var zoom = 1
        // if(data==1){
        //   zoom=2
        // }else{
        //   zoom=1
        // }
        // setScale(zoom)
      })
      freqCharts.onFocus(function (data) {
        console.log("控件焦点", data)
        //focusMessage(data)
        var message;
        if (data === '') {
          message = '{"callback_type":"chart_focus","callback_data":{"focus_type":""}}';
        } else if (data === 'chart') {
          message = '{"callback_type":"chart_focus","callback_data":{"focus_type":"chart"}}';
        }
        sendMessage(message)
      })
      freqCharts.onSwitch(function (data) {
        console.log("控件切换消息", data)
        //switchMessage(data)
        var message = '{"callback_type":"click_switch_button","callback_data":{"data_type":"switch_button"}}'
        sendMessage(message)
      })

      console.log("控件配置",freqCharts.getOptions())
      document.getElementById("mycanvas").addEventListener('click',(e)=>{
        var infoText ='---mycanvas屏幕坐标 (screenX/Y): ' + event.screenX + ', ' + event.screenY + '\n';
        showconsole(infoText)
      })
      document.querySelector('canvas').addEventListener('click',(e)=>{
        var infoText ='---canvas屏幕坐标 (screenX/Y): ' + event.screenX + ', ' + event.screenY + '\n';
        showconsole(infoText)
      })
      document.getElementById("zoom_in").addEventListener('click',(e)=>{
        var infoText ='---缩放屏幕坐标 (screenX/Y): ' + event.screenX + ', ' + event.screenY + '\n';
        showconsole(infoText)
      })
      document.getElementById("switch_button").addEventListener('click',(e)=>{
        var infoText ='---切换 (screenX/Y): ' + event.screenX + ', ' + event.screenY + '\n';
        showconsole(infoText)
      })
      document.getElementsByTagName("canvas")[0].addEventListener('touchstart',function(event){
        var infoText ='---canvas触摸 (screenX/Y): ' + event.screenX + ', ' + event.screenY + '\n';
        showconsole(infoText)
      })
    }


    function updateOptionClick() {
      var data = {
        "operate_type": "update_options",
        "operate_data": {
          "data_options": {
            "language_code": 1033, //语言代码 2052中文 1033英文
            "background": [255, 255, 255, 1], //背景色
            "grid": { //网格样式
              "left": 60, //左边距
            },
            "x_axis": { //X轴样式
              "decimals": 4, //X轴刻度标签小数位数
              "unit": "", //单位MHz 为空不显示 
            }
          }
        }
      }
      startmethod(data)
    }
    function changeClick(){
      var data = {
        "operate_type": "update_options",
        "operate_data": {
          "data_options": {
            "isPrint":isopenConsole, //是否打印
          }
        }
      }
      startmethod(data)
    }

    function updateClick(data) {
      var data = {
        "operate_type": "update_chart", //操作类型
        "operate_data": {
          "data_chart": filedata
        }
      }
      startmethod(data)
    }

    function setfreqClick() {
        var start = document.getElementById("minfreq").value-0
        var end = document.getElementById("maxfreq").value-0
      var data = {
        "operate_type": "set_freq_range",
        "operate_data": {
          "data_freqs": {
            "type": "view", //init初始化  view 视图范围
            "start": start || 2200000,
            "end": end || 2300000
          }
        }
      }
      startmethod(data)
    }
    function setInitFreqClick(){
      var data = {
        "operate_type": "set_freq_range",
        "operate_data": {
          "data_freqs": {
            "type": "init", //init初始化  view 视图范围
            "start": 1000000,
            "end": 2000000000
          }
        }
      }
      startmethod(data)
    }
    //锁屏
    function setlock(data) {
      var data = {
        "operate_type": "set_lock",
        "operate_data": {
          "lock_status": data, //锁定状态遮罩
        }
      }
      startmethod(data)
      setTimeout(function(){
        outlock()
      }, 6000);
    }

    function outlock() {
      var data = {
        "operate_type": "set_lock",
        "operate_data": {
          "lock_status": false
        }
      }
      startmethod(data)
    }
    function setKey(key) {
      var data = {
        "operate_type": "set_key",
        "operate_data": {
          "data_key": {
            "type": key,//0 上 1下 2左 3右 4确认 5返回 6清除控制模式
            "action": 0,//0 单击1双击2长按3释放
          }
        }
      }
      startmethod(data)
    }

    function setChannelShow(){
      var data = {
        "operate_type": "set_channel_show",
        "operate_data": {
          "data_show": "show",//show 显示 hide 隐藏 auto 自动控件控制默认auto
        }
      }
      startmethod(data)
    }
    function setScrollbarShow(){
      var data = {
        "operate_type": "set_scrollbar_show",
        "operate_data": {
          "data_show": "show",//show 显示 hide 隐藏 auto 自动控件控制默认auto
        }
      }
      startmethod(data)
    }
    //获取频率业务名称
    function getFreqBussiness(){
      var data = {
        "operate_type": "get_freq_bussiness",
        "operate_data": {
          "data_freqs": {
            "start": 1000000000,
            "end": 3000000000
          }
        }
      }
      startmethod(data)
    }

    //  new QWebChannel(qt.webChannelTransport, function(channel) {
    //      window.bridge = channel.objects.bridge;
    //      //bridge.recvDataFromWebFun('{"callback_type":"get_chart"}')
    //  })

    if(isSendOk){
      new QWebChannel(qt.webChannelTransport, function(channel) {
         window.bridge = channel.objects.bridge;
         bridge.recvDataFromWebFun('{"callback_type":"get_chart"}')
         bridge.sendDataToWebSignal.connect(function(data) {
           console.log("web发送数据", data)
           showconsole(data)
           startmethod(data)
         })
     })
    }
    

    function gridClickMessage(data) {
      var business_id = data.business_id||"";
      var foot_note = [];
      var name = data.text || "";
      console.log("处理点击事件消息", data)
      if(data.foot_notes&&data.foot_notes.length>0){
        foot_note=foot_note.concat(data.foot_notes)
      }else if(data.parent_foot_notes&&data.parent_foot_notes.length>0){
        foot_note=foot_note.concat(data.parent_foot_notes)
      }
      if(data.foot_note&&data.foot_note.length>0){
        foot_note=foot_note.concat(data.foot_note)
      }
      // 构造 message 对象
      var messageObj = {
        callback_type: "click_grid",
        callback_data: {
          data_type: "grid_chart",
          business_id: business_id,
          names: name,
          foot_note: foot_note,
          start:data.start_freq,
          end:data.end_freq
        }
      };
      
      // 将 message 对象转换为 JSON 字符串
      var message = JSON.stringify(messageObj);
      console.log(message)
      sendMessage(message)
    }


    

    function sendMessage(message) {
      console.log("发送消息", message)
      showconsole(message)
      if(isSendOk){
        bridge.recvDataFromWebFun(message)
      }
    }








    // document.querySelector("canvas").addEventListener('touchstart',function(){
        
    // })

    var isdevice=false
    window.addEventListener('click', (event) => {
        var infoText = '';
            
        // 组装坐标信息字符串
        infoText += '---屏幕坐标 (screenX/Y): ' + event.screenX + ', ' + event.screenY + '\n';
        // infoText += '窗口坐标 (clientX/Y): ' + event.clientX + ', ' + event.clientY + '\n';
        infoText += '页面坐标 (pageX/Y): ' + event.pageX + ', ' + event.pageY + '\n\n';
        // 添加设备信息
        if(!isdevice){
            infoText += '设备信息:\n';
            infoText += '分辨率: ' + screen.width + 'x' + screen.height + '\n';
            infoText += '像素比: ' + window.devicePixelRatio + '\n';
            infoText += '用户代理: ' + navigator.userAgent;
            isdevice=true
        }
        showconsole(infoText)
    });


    // 创建多个元素的HTML字符串
    var htmlContent = '';


    // 使用innerHTML添加多个元素
    document.getElementById("consolelogs").innerHTML += htmlContent;
    // };
    function showconsole(data) {
      if(isopenConsole==false){
        return false;
      }
      var nowdragtimes = new Date().getTime()
      if(typeof data==='object'&&data!==null){
        data=JSON.stringify(data)
      }
      var reqdata=data.replace(/\s+/g,'')
      var texts = '<p><span>' + nowdragtimes + '</span>' + reqdata + '</p>'
      // $("#consolelogs").append(texts)
      document.getElementById("consolelogs").innerHTML += texts
    }
    window.addEventListener('error', function (errorMessage, scriptURI, lineNo, columnNo, error) {
      var texts = "message:" + errorMessage.message + ",line:" + errorMessage.lineno + ",filename:" + errorMessage
        .filename + ",error" + JSON.stringify(errorMessage)
      var reqdata = {
        "callback_type":"map_log报错",
        "name":"代码报错报错报错",
        "callback_data":texts
      };
      showconsole(reqdata)
    }, true);

    function cleartext() {
      document.getElementById("consolelogs").innerHTML = '';
    }
    function openConsole(){
      isopenConsole=!isopenConsole;
      changeClick()
    }
    function colsePopup(){
      isopenConsole=false;
      document.getElementById("consolelogs-box").style.display="none";
    }
    function openPopup(){
      isopenConsole=true;
      document.getElementById("consolelogs-box").style.display="block";
    }
    function showbutton(){
      document.getElementById("bottom-box").style.display="flex";
      document.getElementById("mycanvas").style.height="80%";
    }

    if(isSendOk==false){
      showbutton()
    }








    


  // $.getJSON('./freqdata/ghz.json', function(data) {
  //   console.log(data);
  // }).fail(err => console.log('请求失败:', err));

  // fetch('./freqdata/ghz.json')
  //   .then(response => response.json())
  //   .then(data => console.log(data))
  //   .catch(error => console.error('读取失败:', error));

  // var xhr = new XMLHttpRequest();
  // xhr.open('GET', './freqdata/ghz.json', true);
  // xhr.onload = function() {
  //   if (xhr.status === 200) {
  //     var jsonData = JSON.parse(xhr.responseText);
  //     console.log(jsonData);
  //   }
  // };
  // xhr.send();
document.getElementById('jsonFile').addEventListener('change', function(e) {
  var files = e.target.files; //获取文件列表
  if (files.length === 0) {
    console.log("没有选择文件");
    return;
  }
  var file = files[0]; //获取第一个文件
  var name = file.name;//读取选中文件的文件名
  var size = file.size/1024;//读取选中文件的大小
  console.log("文件名:"+name+"大小："+size);
  document.getElementById("fileinfo").innerHTML = "</br>文件名:"+name+"</br>大小："+size+"KB";
  var reader = new FileReader();
  reader.onload = function(e) {
    var content = e.target.result; //获取文件内容
    var json = JSON.parse(content);
    console.log("json数据：",json);
    filedata=json
    
    //alert("文件读取成功！\n文件名："+name+"\n文件大小："+size+"字节\n文件内容：");
  };
  reader.readAsText(file); //读取文件内容
});

function getmus(){
  if (!!window.performance && !!performance.memory) {
      var mem = performance.memory;
      var usedMB = (mem.usedJSHeapSize / 1048576).toFixed(2);
      var totalMB = (mem.jsHeapSizeLimit / 1048576).toFixed(2);
      var texts = '内存'+usedMB + 'MB / ' + totalMB + 'MB';
      console.log(navigator)
      showconsole(texts)
  }
}
function getOptions(){
  showconsole(freqCharts.getOptions())
}

 </script>

</body>

</html>